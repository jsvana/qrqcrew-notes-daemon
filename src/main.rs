use anyhow::Result;
use clap::Parser;
use qrqcrew_notes_daemon::{Config, CsvFetcher, GitHubClient, NotesGenerator};
use std::path::PathBuf;
use std::time::Duration;
use tokio::time::sleep;
use tracing::{error, info, warn};

#[derive(Parser)]
#[command(name = "qrqcrew-notes-daemon")]
#[command(about = "Generate Ham2K PoLo callsign notes from QRQ Crew roster")]
struct Cli {
    /// Path to config file
    #[arg(short, long, default_value = "config.toml")]
    config: PathBuf,

    /// Run once and exit (override config)
    #[arg(long)]
    once: bool,

    /// Dry run - don't commit to GitHub
    #[arg(long)]
    dry_run: bool,
}

#[tokio::main]
async fn main() -> Result<()> {
    // Initialize tracing
    tracing_subscriber::fmt()
        .with_env_filter(
            tracing_subscriber::EnvFilter::from_default_env()
                .add_directive("qrqcrew_notes_daemon=info".parse()?),
        )
        .init();

    let cli = Cli::parse();
    let config = Config::load(Some(cli.config))?;

    let run_once = cli.once || config.daemon.run_once;

    info!("Starting QRQ Crew callsign notes daemon");

    loop {
        if let Err(e) = sync_once(&config, cli.dry_run).await {
            error!("Sync failed: {}", e);
        }

        if run_once {
            info!("Run-once mode, exiting");
            break;
        }

        info!("Sleeping for {} seconds", config.daemon.sync_interval_secs);
        sleep(Duration::from_secs(config.daemon.sync_interval_secs)).await;
    }

    Ok(())
}

async fn sync_once(config: &Config, dry_run: bool) -> Result<()> {
    info!("Starting sync");

    // 1. Fetch roster
    let fetcher = CsvFetcher::new(config.roster_url.clone());
    let members = fetcher.fetch_members().await?;
    info!("Fetched {} members from roster", members.len());

    if members.is_empty() {
        warn!("No members found in roster, skipping commit");
        return Ok(());
    }

    // 2. Generate notes file
    let generator = NotesGenerator::new(config.output.emoji.clone());
    let content = generator.generate(&members);

    if dry_run {
        info!("Dry run - would generate:\n{}", content);
        return Ok(());
    }

    // 3. Check if changed and commit
    let github = GitHubClient::new(&config.github)?;

    if !github.content_changed(&content).await? {
        info!("No changes detected, skipping commit");
        return Ok(());
    }

    let commit_msg = format!(
        "Update callsign notes ({} members)\n\nGenerated by qrqcrew-notes-daemon",
        members.len()
    );

    github.commit_file(&content, &commit_msg).await?;
    info!("Successfully committed callsign notes");

    Ok(())
}
